<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Penjadwalan Otomatis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --sidebar-bg: rgba(15, 23, 42, 0.6);
            --card-bg: rgba(15, 23, 42, 0.7);
            --text-color: #f1f5f9;
            --text-muted-color: #94a3b8;
            --accent-color: #22d3ee; /* Cyan-400 */
            --active-link-bg: rgba(34, 211, 238, 0.1);
            --table-header-bg: rgba(255,255,255,0.05);
            --table-border: rgba(255,255,255,0.1);
            --schedule-item-bg: linear-gradient(135deg, #22d3ee, #67e8f9);
            --schedule-item-text: #0f172a;
            --modal-backdrop: rgba(0, 0, 0, 0.7);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
        }
        
        #tech-background {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .schedule-item { cursor: pointer; }
        .schedule-item-empty { min-height: 60px; cursor: pointer; }

        .selected-for-swap {
            outline: 3px solid var(--accent-color);
            box-shadow: 0 0 15px var(--accent-color);
            transform: scale(1.05);
            transition: all 0.2s ease-in-out;
        }
        
        .swap-valid {
            outline: 2px solid #22c55e; /* green-500 */
        }
        .swap-conflict {
            outline: 2px solid #ef4444; /* red-500 */
            background-color: rgba(239, 68, 68, 0.1);
            cursor: not-allowed !important;
        }
    </style>
</head>
<body>

    <canvas id="tech-background"></canvas>

    <div class="flex h-screen p-2 md:p-4 gap-4">
        <!-- Sidebar -->
        <aside class="flex-shrink-0 w-64 p-2 glass-card rounded-2xl hidden md:flex flex-col">
            <div class="flex items-center gap-3 p-4">
                <div class="bg-cyan-500 p-2 rounded-lg shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                </div>
                <h1 class="text-xl font-bold tracking-tight">AutoScheduler</h1>
            </div>
            <nav id="sidebar-nav" class="mt-6 space-y-2 flex-grow">
                <a href="#dashboard" class="sidebar-link active flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-semibold"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>Dashboard</a>
                <a href="#data" class="sidebar-link flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-semibold"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>Master Data</a>
                <a href="#jadwal" class="sidebar-link flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-semibold"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>Buat Jadwal</a>
                <a href="#pengaturan" class="sidebar-link flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-semibold"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>Pengaturan</a>
            </nav>
            <div class="mt-auto p-4 text-center text-xs" style="color: var(--text-muted-color);">
                Aplikasi Beta <br> Dikembangkan oleh <strong>Alfian Firdausi</strong>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 glass-card rounded-2xl overflow-y-auto">
            <div id="content-area" class="p-4 md:p-6">
                <!-- Views will be injected here -->
            </div>
        </main>
    </div>
    
    <!-- Mobile Bottom Nav -->
    <nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 glass-card border-t p-2 flex justify-around" style="border-color: var(--table-border);">
        <a href="#dashboard" class="sidebar-link active flex-1 flex flex-col items-center justify-center p-2 rounded-lg text-xs font-semibold">Dashboard</a>
        <a href="#data" class="sidebar-link flex-1 flex flex-col items-center justify-center p-2 rounded-lg text-xs font-semibold">Data</a>
        <a href="#jadwal" class="sidebar-link flex-1 flex flex-col items-center justify-center p-2 rounded-lg text-xs font-semibold">Jadwal</a>
        <a href="#pengaturan" class="sidebar-link flex-1 flex flex-col items-center justify-center p-2 rounded-lg text-xs font-semibold">Pengaturan</a>
    </nav>


    <!-- Modals -->
    <div id="kelas-modal" class="fixed inset-0 z-50 hidden items-center justify-center transition-opacity" style="background-color: var(--modal-backdrop);"><div class="glass-card rounded-lg shadow-xl w-11/12 max-w-sm p-6"><h3 class="text-lg font-bold mb-4">Data Kelas</h3><form id="kelas-form"></form></div></div>
    <div id="guru-modal" class="fixed inset-0 z-50 hidden items-center justify-center transition-opacity" style="background-color: var(--modal-backdrop);"><div class="glass-card rounded-lg shadow-xl w-11/12 max-w-sm p-6"><h3 class="text-lg font-bold mb-4">Data Guru</h3><form id="guru-form"></form></div></div>
    <div id="matapelajaran-modal" class="fixed inset-0 z-50 hidden items-center justify-center transition-opacity" style="background-color: var(--modal-backdrop);"><div class="glass-card rounded-lg shadow-xl w-11/12 max-w-sm p-6"><h3 class="text-lg font-bold mb-4">Data Mata Pelajaran</h3><form id="matapelajaran-form"></form></div></div>
    <div id="alokasi-modal" class="fixed inset-0 z-50 hidden items-center justify-center transition-opacity" style="background-color: var(--modal-backdrop);"><div class="glass-card rounded-lg shadow-xl w-11/12 max-w-sm p-6"><h3 class="text-lg font-bold mb-4">Alokasi Pelajaran</h3><form id="alokasi-form"></form></div></div>
    
    <div id="toast" class="fixed bottom-20 md:bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-all z-50 transform translate-y-2"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const contentArea = document.getElementById('content-area');
    
    // --- TEMPLATES & INJECTION ---
    const viewTemplates = {
        'view-jadwal': `
            <div class="flex flex-col sm:flex-row gap-3 mb-4">
                <button id="generate-all-schedules-btn" class="w-full sm:w-auto flex-grow bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2.5 px-5 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                    Buat Jadwal Baru
                </button>
                <button id="import-csv-btn" class="w-full sm:w-auto bg-violet-500 hover:bg-violet-600 text-white font-bold py-2.5 px-5 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                    Import Jadwal
                </button>
                <input type="file" id="import-csv-input" class="hidden" accept=".csv">
                <button id="export-all-csv-btn" class="w-full sm:w-auto bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-5 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 11h8"/><path d="M8 16h8"/><path d="M11 8v8"/></svg>
                    Export Jadwal
                </button>
            </div>
            <p class="text-sm text-cyan-200 mb-6 p-3 bg-cyan-500/10 rounded-lg border border-cyan-500/20">💡 **Tips:** Klik pada satu jadwal untuk memilih, lalu klik pada slot lain untuk menukar. Slot <span class="border-b-2 border-green-400">hijau</span> aman, slot <span class="border-b-2 border-red-400">merah</span> bentrok.</p>
            <div id="schedule-container" class="space-y-10">
                 <p class="text-center text-slate-400 p-4">Buat atau import jadwal untuk menampilkannya di sini.</p>
            </div>`,
        'view-data': `
            <div class="space-y-8">
                <div>
                    <div class="flex justify-between items-center mb-2"><h3 class="text-2xl font-semibold tracking-tight">Data Kelas</h3><button id="add-kelas-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-1.5 px-4 rounded-md shadow text-sm flex items-center gap-1.5 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg> Tambah</button></div>
                    <div class="glass-card rounded-lg border-none overflow-hidden shadow-sm"><table class="w-full"><tbody id="kelas-list"></tbody></table></div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2"><h3 class="text-2xl font-semibold tracking-tight">Data Guru</h3><button id="add-guru-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-1.5 px-4 rounded-md shadow text-sm flex items-center gap-1.5 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg> Tambah</button></div>
                    <div class="glass-card rounded-lg border-none overflow-hidden shadow-sm"><table class="w-full"><tbody id="guru-list"></tbody></table></div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2"><h3 class="text-2xl font-semibold tracking-tight">Data Mata Pelajaran</h3><button id="add-matapelajaran-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-1.5 px-4 rounded-md shadow text-sm flex items-center gap-1.5 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg> Tambah</button></div>
                    <div class="glass-card rounded-lg border-none overflow-hidden shadow-sm"><table class="w-full"><tbody id="matapelajaran-list"></tbody></table></div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2"><h3 class="text-2xl font-semibold tracking-tight">Alokasi Pelajaran & Guru</h3><button id="add-alokasi-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-1.5 px-4 rounded-md shadow text-sm flex items-center gap-1.5 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg> Tambah</button></div>
                    <div class="glass-card rounded-lg border-none overflow-hidden shadow-sm"><table class="w-full"><tbody id="alokasi-list"></tbody></table></div>
                </div>
            </div>`,
        'view-dashboard': `
            <h3 class="text-2xl font-semibold tracking-tight mb-4">Dashboard</h3>
            <div class="mb-8">
                <h4 class="text-xl font-semibold mb-3">Status Jadwal Kelas</h4>
                <div id="dashboard-status" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Status cards will be injected here -->
                </div>
            </div>
            <div class="space-y-6 glass-card rounded-xl p-6">
                <div>
                    <h4 class="text-xl font-semibold mb-2">Panduan Penggunaan</h4>
                    <p style="color: var(--text-muted-color);">Ikuti langkah-langkah di bawah ini untuk memulai.</p>
                </div>
                <div class="space-y-4">
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-cyan-500 text-white flex items-center justify-center font-bold">1</div>
                        <div>
                            <h5 class="font-semibold">Isi Master Data</h5>
                            <p style="color: var(--text-muted-color);">Buka tab <strong>Master Data</strong>. Masukkan semua data yang dibutuhkan: <strong>Data Kelas</strong>, <strong>Data Guru</strong>, dan <strong>Data Mata Pelajaran</strong>.</p>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-cyan-500 text-white flex items-center justify-center font-bold">2</div>
                        <div>
                            <h5 class="font-semibold">Alokasikan Pelajaran</h5>
                            <p style="color: var(--text-muted-color);">Masih di tab Master Data, buka bagian <strong>Alokasi Pelajaran & Guru</strong>. Tentukan guru mana mengajar mata pelajaran apa, di kelas mana, dan berapa total sesi per minggunya.</p>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-cyan-500 text-white flex items-center justify-center font-bold">3</div>
                        <div>
                            <h5 class="font-semibold">Buat Jadwal Otomatis</h5>
                            <p style="color: var(--text-muted-color);">Pindah ke tab <strong>Buat Jadwal</strong>. Klik tombol <strong>"Buat Jadwal Baru"</strong>. Sistem akan menyusun jadwal untuk semua kelas secara acak dan memastikan tidak ada jadwal guru yang bentrok.</p>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-cyan-500 text-white flex items-center justify-center font-bold">4</div>
                        <div>
                            <h5 class="font-semibold">Sesuaikan, Simpan, & Muat</h5>
                            <p style="color: var(--text-muted-color);">Jika ada jadwal yang kurang sesuai, ubah posisinya dengan <strong>klik-dan-tukar</strong>. Setelah final, klik <strong>"Export Jadwal"</strong> untuk menyimpan file jadwal. Keesokan harinya, Anda bisa memuat kembali jadwal tersebut menggunakan tombol <strong>"Import Jadwal"</strong>.</p>
                        </div>
                    </div>
                </div>
                <div class="border-t pt-4 mt-6 text-center text-sm" style="border-color: var(--table-border); color: var(--text-muted-color);">
                    <p>Aplikasi ini masih dalam tahap <strong>BETA</strong>.</p>
                    <p>Dikembangkan oleh <strong>Alfian Firdausi</strong>.</p>
                </div>
            </div>`,
        'view-pengaturan': `
            <h3 class="text-2xl font-semibold tracking-tight mb-4">Pengaturan</h3>
            <div class="space-y-6">
               <div>
                   <h4 class="text-xl font-semibold text-red-400 mb-2">Zona Berbahaya</h4>
                   <div class="bg-red-500/10 border border-red-500/20 p-4 rounded-xl">
                      <p class="text-sm text-red-300 mt-1 mb-3">Tindakan ini akan menghapus semua data (kelas, guru, mapel, alokasi, dan jadwal) secara permanen.</p>
                       <button id="delete-all-data-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center gap-2">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                          Hapus Semua Data
                      </button>
                   </div>
              </div>
            </div>`
    };
    
    const modalFormTemplates = {
        'kelas-form': `<input type="hidden" id="kelas-id"><div class="mb-4"><label for="nama-kelas" class="block text-sm font-medium mb-1">Nama Kelas</label><input type="text" id="nama-kelas" class="w-full bg-slate-800/20 border-slate-600 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 text-slate-100 placeholder:text-slate-400" placeholder="Contoh: 10 IPA 1" required></div><div class="flex justify-end gap-2"><button type="button" class="close-modal-btn bg-slate-600 hover:bg-slate-500 text-slate-200 py-2 px-4 rounded-md transition-colors">Batal</button><button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white py-2 px-4 rounded-md transition-colors">Simpan</button></div>`,
        'guru-form': `<input type="hidden" id="guru-id"><div class="mb-4"><label for="nama-guru" class="block text-sm font-medium mb-1">Nama Guru</label><input type="text" id="nama-guru" class="w-full bg-slate-800/20 border-slate-600 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 text-slate-100 placeholder:text-slate-400" placeholder="Contoh: Budi Santoso" required></div><div class="flex justify-end gap-2"><button type="button" class="close-modal-btn bg-slate-600 hover:bg-slate-500 text-slate-200 py-2 px-4 rounded-md transition-colors">Batal</button><button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white py-2 px-4 rounded-md transition-colors">Simpan</button></div>`,
        'matapelajaran-form': `<input type="hidden" id="matapelajaran-id"><div class="mb-4"><label for="nama-matapelajaran" class="block text-sm font-medium mb-1">Nama Mata Pelajaran</label><input type="text" id="nama-matapelajaran" class="w-full bg-slate-800/20 border-slate-600 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 text-slate-100 placeholder:text-slate-400" placeholder="Contoh: Matematika" required></div><div class="flex justify-end gap-2"><button type="button" class="close-modal-btn bg-slate-600 hover:bg-slate-500 text-slate-200 py-2 px-4 rounded-md transition-colors">Batal</button><button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white py-2 px-4 rounded-md transition-colors">Simpan</button></div>`,
        'alokasi-form': `<input type="hidden" id="alokasi-id"><div class="space-y-4"><label class="block"><span class="text-sm font-medium">Mata Pelajaran</span><select id="alokasi-mapel" class="w-full mt-1 bg-slate-800/20 border-slate-600 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 text-slate-100" required></select></label><label class="block"><span class="text-sm font-medium">Guru</span><select id="alokasi-guru" class="w-full mt-1 bg-slate-800/20 border-slate-600 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 text-slate-100" required></select></label><label class="block"><span class="text-sm font-medium">Untuk Kelas</span><select id="alokasi-kelas" class="w-full mt-1 bg-slate-800/20 border-slate-600 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 text-slate-100" required></select></label><label class="block"><span class="text-sm font-medium">Jumlah Sesi per Minggu</span><input type="number" id="alokasi-sesi" class="w-full mt-1 bg-slate-800/20 border-slate-600 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500 text-slate-100 placeholder:text-slate-400" placeholder="Contoh: 4" min="1" required></label></div><div class="flex justify-end gap-2 mt-6"><button type="button" class="close-modal-btn bg-slate-600 hover:bg-slate-500 text-slate-200 py-2 px-4 rounded-md transition-colors">Batal</button><button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white py-2 px-4 rounded-md transition-colors">Simpan</button></div>`
    };

    Object.keys(viewTemplates).forEach(key => {
        const viewDiv = document.createElement('div');
        viewDiv.id = key;
        viewDiv.innerHTML = viewTemplates[key];
        contentArea.appendChild(viewDiv);
    });

    for(const formId in modalFormTemplates) {
        document.getElementById(formId).innerHTML = modalFormTemplates[formId];
    }
    
    // --- STATE & CONSTANTS ---
    let kelas = JSON.parse(localStorage.getItem('SCHEDULER_KELAS')) || [];
    let guru = JSON.parse(localStorage.getItem('SCHEDULER_GURU')) || [];
    let mataPelajaran = JSON.parse(localStorage.getItem('SCHEDULER_MATAPELAJARAN')) || [];
    let alokasiPelajaran = JSON.parse(localStorage.getItem('SCHEDULER_ALOKASI')) || [];
    let schedules = JSON.parse(localStorage.getItem('SCHEDULER_SCHEDULES')) || [];
    const daysOrder = ['Sabtu', 'Ahad', 'Senin', 'Selasa', 'Rabu', 'Kamis'];
    const allSessions = Array.from({length: 6*7}, (_, i) => ({
        hari: daysOrder[Math.floor(i/7)],
        sesi: `Sesi ${i%7 + 1}`
    }));

    // --- FUNCTION DEFINITIONS ---
    const saveToLocalStorage = () => {
        localStorage.setItem('SCHEDULER_KELAS', JSON.stringify(kelas));
        localStorage.setItem('SCHEDULER_GURU', JSON.stringify(guru));
        localStorage.setItem('SCHEDULER_MATAPELAJARAN', JSON.stringify(mataPelajaran));
        localStorage.setItem('SCHEDULER_ALOKASI', JSON.stringify(alokasiPelajaran));
        localStorage.setItem('SCHEDULER_SCHEDULES', JSON.stringify(schedules));
    };
    
    const showToast = (message, isError = false) => {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `fixed bottom-20 md:bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl opacity-0 transition-all z-50 transform translate-y-2 ${isError ? 'bg-red-500' : 'bg-emerald-500'}`;
        setTimeout(() => {
            toast.classList.remove('opacity-0', 'translate-y-2');
            toast.classList.add('opacity-100', 'translate-y-0');
        }, 100);
        setTimeout(() => {
            toast.classList.remove('opacity-100', 'translate-y-0');
            toast.classList.add('opacity-0', 'translate-y-2');
        }, 3000);
    };

    const updateButtonStates = () => {
        const generateBtn = document.getElementById('generate-all-schedules-btn');
        const exportBtn = document.getElementById('export-all-csv-btn');
        const hasMasterData = kelas.length > 0 && alokasiPelajaran.length > 0;
        if(generateBtn) generateBtn.disabled = !hasMasterData;
        if(exportBtn) exportBtn.disabled = Object.keys(schedules).length > 0;
    };

    const renderKelasList = () => {
        const list = document.getElementById('kelas-list');
        list.innerHTML = kelas.length === 0 ? `<tr><td class="p-4 text-center text-slate-400">Belum ada data kelas.</td></tr>` :
            kelas.map(k => `<tr class="border-b" style="border-color: var(--table-border);"><td class="p-3 font-medium">${k.nama}</td><td class="p-3 text-right"><button data-id="${k.id}" data-type="kelas" class="edit-btn text-cyan-400 hover:text-cyan-200 font-semibold mr-3 p-1 text-sm">Edit</button><button data-id="${k.id}" data-type="kelas" class="delete-btn text-red-400 hover:text-red-300 font-semibold p-1 text-sm">Hapus</button></td></tr>`).join('');
        updateButtonStates();
    };
    const renderGuruList = () => {
        const list = document.getElementById('guru-list');
        list.innerHTML = guru.length === 0 ? `<tr><td class="p-4 text-center text-slate-400">Belum ada data guru.</td></tr>` :
            guru.map(g => `<tr class="border-b" style="border-color: var(--table-border);"><td class="p-3 font-medium">${g.nama}</td><td class="p-3 text-right"><button data-id="${g.id}" data-type="guru" class="edit-btn text-cyan-400 hover:text-cyan-200 font-semibold mr-3 p-1 text-sm">Edit</button><button data-id="${g.id}" data-type="guru" class="delete-btn text-red-400 hover:text-red-300 font-semibold p-1 text-sm">Hapus</button></td></tr>`).join('');
    };
    const renderMataPelajaranList = () => {
        const list = document.getElementById('matapelajaran-list');
        list.innerHTML = mataPelajaran.length === 0 ? `<tr><td class="p-4 text-center text-slate-400">Belum ada data mata pelajaran.</td></tr>` :
            mataPelajaran.map(m => `<tr class="border-b" style="border-color: var(--table-border);"><td class="p-3 font-medium">${m.nama}</td><td class="p-3 text-right"><button data-id="${m.id}" data-type="matapelajaran" class="edit-btn text-cyan-400 hover:text-cyan-200 font-semibold mr-3 p-1 text-sm">Edit</button><button data-id="${m.id}" data-type="matapelajaran" class="delete-btn text-red-400 hover:text-red-300 font-semibold p-1 text-sm">Hapus</button></td></tr>`).join('');
    };
    const renderAlokasiList = () => {
        const list = document.getElementById('alokasi-list');
        if (alokasiPelajaran.length === 0) {
            list.innerHTML = `<tr><td class="p-4 text-center text-slate-400">Belum ada data alokasi.</td></tr>`;
            return;
        }
        list.innerHTML = alokasiPelajaran.map(a => {
            const m = mataPelajaran.find(m => m.id === a.mapelId);
            const g = guru.find(g => g.id === a.guruId);
            const k = kelas.find(k => k.id === a.kelasId);
            const mapelName = m ? m.nama : `<span class="text-red-500">N/A</span>`;
            const guruName = g ? g.nama : `<span class="text-red-500">N/A</span>`;
            const kelasName = k ? k.nama : `<span class="text-red-500">N/A</span>`;
            return `<tr class="border-b" style="border-color: var(--table-border);"><td class="p-3"><div class="font-medium">${mapelName} (${a.sesi} Sesi)</div><div class="text-sm" style="color: var(--text-muted-color);">${guruName} &mdash; <strong>${kelasName}</strong></div></td><td class="p-3 text-right"><button data-id="${a.id}" data-type="alokasi" class="edit-btn text-cyan-400 hover:text-cyan-200 font-semibold mr-3 p-1 text-sm">Edit</button><button data-id="${a.id}" data-type="alokasi" class="delete-btn text-red-400 hover:text-red-300 font-semibold p-1 text-sm">Hapus</button></td></tr>`;
        }).join('');
        updateButtonStates();
    };
    const renderAllLists = () => {
        renderKelasList();
        renderGuruList();
        renderMataPelajaranList();
        renderAlokasiList();
    };
    
    const initializeClickToSwap = () => {
        let firstSelection = null;
        const scheduleContainer = document.getElementById('schedule-container');

        scheduleContainer.addEventListener('click', e => {
            const targetCell = e.target.closest('td[data-day]');
            
            const clearHighlights = () => {
                if (firstSelection) {
                    firstSelection.element.classList.remove('selected-for-swap');
                }
                document.querySelectorAll('.swap-valid, .swap-conflict').forEach(cell => {
                    cell.classList.remove('swap-valid', 'swap-conflict');
                });
                firstSelection = null;
            };

            if (!targetCell) {
                clearHighlights();
                return;
            }

            const className = targetCell.closest('.schedule-table').dataset.className;
            const day = targetCell.dataset.day;
            const sesi = targetCell.dataset.sesi;
            const scheduleItem = targetCell.querySelector('.schedule-item');
            const elementToSelect = scheduleItem || targetCell;

            if (!firstSelection) {
                firstSelection = { element: elementToSelect, className, day, sesi };
                elementToSelect.classList.add('selected-for-swap');
                
                const sourceData = schedules[firstSelection.className]?.[firstSelection.day]?.[firstSelection.sesi];
                
                document.querySelectorAll('td[data-day]').forEach(cell => {
                    if (cell === targetCell) return;
                    
                    const targetClassName = cell.closest('.schedule-table').dataset.className;
                    const targetDay = cell.dataset.day;
                    const targetSesi = cell.dataset.sesi;
                    const targetData = schedules[targetClassName]?.[targetDay]?.[targetSesi];

                    const checkConflict = (data, day, sesi, currentClassName, otherClassName) => {
                        if (!data) return false;
                        for (const cn in schedules) {
                            if (cn === currentClassName || cn === otherClassName) continue;
                            if (schedules[cn]?.[day]?.[sesi]?.guru === data.guru) {
                                return true;
                            }
                        }
                        return false;
                    };

                    if (checkConflict(sourceData, targetDay, targetSesi, firstSelection.className, targetClassName) ||
                        checkConflict(targetData, firstSelection.day, firstSelection.sesi, targetClassName, firstSelection.className)) {
                        cell.classList.add('swap-conflict');
                    } else {
                        cell.classList.add('swap-valid');
                    }
                });

            } else {
                if (firstSelection.element === elementToSelect) {
                    clearHighlights();
                    return;
                }

                if (targetCell.classList.contains('swap-conflict')) {
                    showToast('Tidak bisa menukar, jadwal guru bentrok!', true);
                    clearHighlights();
                    return;
                }

                const source = firstSelection;
                const target = { className, day, sesi };

                const sourceData = schedules[source.className]?.[source.day]?.[source.sesi];
                const targetData = schedules[target.className]?.[target.day]?.[target.sesi];

                if (!schedules[source.className]) schedules[source.className] = {};
                if (!schedules[source.className][source.day]) schedules[source.className][source.day] = {};
                if (!schedules[target.className]) schedules[target.className] = {};
                if (!schedules[target.className][target.day]) schedules[target.className][target.day] = {};

                schedules[source.className][source.day][source.sesi] = targetData;
                schedules[target.className][target.day][target.sesi] = sourceData;
                
                if (!targetData) delete schedules[source.className][source.day][source.sesi];
                if (Object.keys(schedules[source.className][source.day]).length === 0) delete schedules[source.className][source.day];

                if (!sourceData) delete schedules[target.className][target.day][target.sesi];
                if (schedules[target.className][target.day] && Object.keys(schedules[target.className][target.day]).length === 0) delete schedules[target.className][target.day];

                saveToLocalStorage();
                renderAllSchedules();
                showToast("Jadwal berhasil ditukar!");
                clearHighlights();
            }
        });
    };

    const renderAllSchedules = () => {
        const container = document.getElementById('schedule-container');
        if (Object.keys(schedules).length === 0 || kelas.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-400 p-4">Buat atau import jadwal untuk menampilkannya di sini.</p>`; return;
        }
        container.innerHTML = kelas.map(k => {
            const classSchedule = schedules[k.nama] || {};
            const uniqueSessions = Array.from({ length: 7 }, (_, i) => `Sesi ${i + 1}`);
            const tableBody = uniqueSessions.map(sesiKey => `
                <tr class="bg-transparent border-b" style="border-color: var(--table-border);">
                    <td class="p-2 border-r font-mono text-xs text-center" style="border-color: var(--table-border); color: var(--text-muted-color);">${sesiKey}</td>
                    ${daysOrder.map(day => {
                        const mapelData = classSchedule[day]?.[sesiKey];
                        const content = mapelData ? `<div class="schedule-item p-2 rounded-lg shadow-md border border-black/10" data-mapel-id="${mapelData.id}" data-guru-nama="${mapelData.guru}"><p class="font-semibold text-sm">${mapelData.nama}</p><p class="text-xs opacity-80">${mapelData.guru}</p></div>` : `<div class="schedule-item-empty"></div>`;
                        return `<td class="p-1.5 border-r text-center align-middle" style="border-color: var(--table-border);" data-day="${day}" data-sesi="${sesiKey}">${content}</td>`;
                    }).join('')}
                </tr>`).join('');
            return `<div><h2 class="text-2xl font-bold mb-3 tracking-tight">${k.nama}</h2><div class="glass-card rounded-xl overflow-hidden shadow-lg"><table class="w-full text-sm text-left schedule-table" data-class-name="${k.nama}"><thead class="text-xs uppercase" style="background-color: var(--table-header-bg);"><tr class="border-b" style="border-color: var(--table-border);"><th class="p-2 border-r w-16 text-center" style="border-color: var(--table-border);">Sesi</th>${daysOrder.map(d => `<th class="p-2 border-r text-center" style="border-color: var(--table-border);">${d}</th>`).join('')}</tr></thead><tbody>${tableBody}</tbody></table></div></div>`;
        }).join('');
    };

    const openModal = (modalId, data = null) => {
        const modal = document.getElementById(modalId);
        const form = modal.querySelector('form');
        form.reset();
        
        if (modalId === 'alokasi-modal') {
             if(kelas.length === 0 || guru.length === 0 || mataPelajaran.length === 0) {
                showToast('Harap isi Data Kelas, Guru, dan Mata Pelajaran dahulu!', true); return;
             }
             const setupSelect = (id, options, defaultText) => {
                const select = document.getElementById(id);
                select.innerHTML = `<option value="">-- ${defaultText} --</option>`;
                options.forEach(opt => select.innerHTML += `<option value="${opt.id}">${opt.nama}</option>`);
             };
             setupSelect('alokasi-mapel', mataPelajaran, 'Pilih Mapel');
             setupSelect('alokasi-guru', guru, 'Pilih Guru');
             setupSelect('alokasi-kelas', kelas, 'Pilih Kelas');

             document.getElementById('alokasi-id').value = data ? data.id : '';
             document.getElementById('alokasi-mapel').value = data ? data.mapelId : '';
             document.getElementById('alokasi-guru').value = data ? data.guruId : '';
             document.getElementById('alokasi-kelas').value = data ? data.kelasId : '';
             document.getElementById('alokasi-sesi').value = data ? data.sesi : '';
        } else {
            const idField = document.getElementById(`${modalId.split('-')[0]}-id`);
            const nameField = document.getElementById(`nama-${modalId.split('-')[0]}`);
            if(idField) idField.value = data ? data.id : '';
            if(nameField) nameField.value = data ? data.nama : '';
        }
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    };
    
    const closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');
    
    const handleFormSubmit = (formId, dataArray, renderFunc, name) => {
        document.getElementById(formId).addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById(`${name}-id`).value;
            let entryData = {};
            if(name === 'alokasi') {
                entryData = { mapelId: document.getElementById('alokasi-mapel').value, guruId: document.getElementById('alokasi-guru').value, kelasId: document.getElementById('alokasi-kelas').value, sesi: parseInt(document.getElementById('alokasi-sesi').value) };
            } else {
                entryData = { nama: document.getElementById(`nama-${name}`).value.trim() };
            }
            if (id) {
                const index = dataArray.findIndex(item => item.id === id);
                if(name === 'kelas' && dataArray[index]) {
                    const oldNama = dataArray[index].nama;
                    if (schedules[oldNama]) { schedules[entryData.nama] = schedules[oldNama]; delete schedules[oldNama]; }
                }
                dataArray[index] = { ...dataArray[index], ...entryData };
            } else {
                dataArray.push({ id: `${name.charAt(0)}-${Date.now()}`, ...entryData });
            }
            saveToLocalStorage();
            renderFunc();
            if(name === 'kelas' || name === 'guru' || name === 'matapelajaran') renderAlokasiList();
            closeModal(`${name}-modal`);
            showToast(`Data ${name} berhasil disimpan!`);
        });
    };
    
    const handleDelete = (id, dataArray, renderFunc, name) => {
        const itemToDelete = dataArray.find(item => item.id === id);
        if (!itemToDelete) {
             console.error(`Item with ID "${id}" not found in "${name}" array.`);
             showToast("Error: Data tidak ditemukan untuk dihapus.", true);
             return;
        }

        if(name === 'kelas' && schedules[itemToDelete.nama]) {
            delete schedules[itemToDelete.nama];
        }
        
        let cascadeKey;
        if (name === 'kelas') cascadeKey = 'kelasId';
        else if (name === 'guru') cascadeKey = 'guruId';
        else if (name === 'matapelajaran') cascadeKey = 'mapelId';

        if (cascadeKey) {
            alokasiPelajaran = alokasiPelajaran.filter(a => a[cascadeKey] !== id);
            renderAlokasiList();
        }
        
        const index = dataArray.findIndex(item => item.id === id);
        if (index > -1) {
            dataArray.splice(index, 1);
        }
        
        saveToLocalStorage();
        renderFunc();
        showToast(`Data ${name} berhasil dihapus!`);
    };

    handleFormSubmit('kelas-form', kelas, renderKelasList, 'kelas');
    handleFormSubmit('guru-form', guru, renderGuruList, 'guru');
    handleFormSubmit('matapelajaran-form', mataPelajaran, renderMataPelajaranList, 'matapelajaran');
    handleFormSubmit('alokasi-form', alokasiPelajaran, renderAlokasiList, 'alokasi');

    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const switchView = (hash) => {
        const targetId = hash.substring(1);
        document.getElementById('view-jadwal').style.display = targetId === 'jadwal' ? 'block' : 'none';
        document.getElementById('view-data').style.display = targetId === 'data' ? 'block' : 'none';
        document.getElementById('view-dashboard').style.display = targetId === 'dashboard' ? 'block' : 'none';
        document.getElementById('view-pengaturan').style.display = targetId === 'pengaturan' ? 'block' : 'none';
        sidebarLinks.forEach(link => {
            link.classList.toggle('active', link.getAttribute('href') === hash);
            if (link.classList.contains('active')) {
                link.style.backgroundColor = 'var(--active-link-bg)';
                link.style.color = 'var(--accent-color)';
            } else {
                link.style.backgroundColor = 'transparent';
                link.style.color = 'var(--text-color)';
            }
        });
        if (targetId === 'dashboard') {
            renderDashboardStatus();
        }
    };
    
    sidebarLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            switchView(link.getAttribute('href'));
        });
    });

    document.getElementById('generate-all-schedules-btn').addEventListener('click', () => {
        if (kelas.length === 0 || alokasiPelajaran.length === 0) {
            showToast('Data Kelas dan Alokasi Pelajaran harus diisi!', true); return;
        }
        schedules = {};
        const teacherSchedule = {};
        let unplacedCount = 0;
        const shuffledKelas = [...kelas].sort(() => Math.random() - 0.5);
        for (const k of shuffledKelas) {
            let subjectBag = [];
            alokasiPelajaran.filter(a => a.kelasId === k.id).forEach(alokasi => {
                for (let i = 0; i < alokasi.sesi; i++) subjectBag.push(alokasi);
            });
            subjectBag.sort(() => Math.random() - 0.5);
            const availableSlots = [...allSessions].sort(() => Math.random() - 0.5);
            if (subjectBag.length > availableSlots.length) {
                showToast(`Error: Sesi mapel di kelas ${k.nama} (${subjectBag.length}) > slot tersedia (${availableSlots.length})!`, true); continue;
            }
            const newClassSchedule = {};
            availableSlots.forEach(slot => {
                if (subjectBag.length === 0) return;
                let placed = false;
                for (let i = 0; i < subjectBag.length && !placed; i++) {
                    const alokasi = subjectBag[i];
                    const guruInfo = guru.find(g => g.id === alokasi.guruId);
                    if (!guruInfo || teacherSchedule[guruInfo.nama]?.[slot.hari]?.includes(slot.sesi)) continue;
                    
                    const mapelInfo = mataPelajaran.find(m => m.id === alokasi.mapelId);
                    if (!mapelInfo) continue;

                    if (!newClassSchedule[slot.hari]) newClassSchedule[slot.hari] = {};
                    newClassSchedule[slot.hari][slot.sesi] = { id: alokasi.id, nama: mapelInfo.nama, guru: guruInfo.nama };
                    
                    if (!teacherSchedule[guruInfo.nama]) teacherSchedule[guruInfo.nama] = {};
                    if (!teacherSchedule[guruInfo.nama][slot.hari]) teacherSchedule[guruInfo.nama][slot.hari] = [];
                    teacherSchedule[guruInfo.nama][slot.hari].push(slot.sesi);
                    
                    subjectBag.splice(i, 1);
                    placed = true;
                }
            });
            unplacedCount += subjectBag.length;
            schedules[k.nama] = newClassSchedule;
        }
        saveToLocalStorage();
        updateButtonStates();
        renderAllSchedules();
        showToast(unplacedCount > 0 ? `Jadwal selesai. ${unplacedCount} sesi tidak dapat ditempatkan.` : `Jadwal berhasil dibuat!`, unplacedCount > 0);
    });

    document.getElementById('import-csv-btn').addEventListener('click', () => {
        document.getElementById('import-csv-input').click();
    });

    document.getElementById('import-csv-input').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            complete: (results) => {
                try {
                    const data = results.data;
                    if (data.length < 2) throw new Error('File CSV kosong atau tidak valid.');

                    const header = data[0].map(h => h.trim());
                    const expectedHeader = ['Kelas', 'Sesi', ...daysOrder];
                    if (JSON.stringify(header) !== JSON.stringify(expectedHeader)) {
                        throw new Error('Format header CSV tidak sesuai. Pastikan file diekspor dari aplikasi ini.');
                    }

                    const tempSchedules = {};
                    const tempClassNames = new Set();
                    const tempGuruNames = new Set();
                    const tempMapelNames = new Set();

                    for (let i = 1; i < data.length; i++) {
                        const row = data[i];
                        if (row.length < expectedHeader.length || !row[0]) continue;

                        const className = row[0].trim();
                        const sesi = row[1].trim();
                        if (!className || !sesi) continue;

                        tempClassNames.add(className);
                        if (!tempSchedules[className]) tempSchedules[className] = {};

                        daysOrder.forEach((day, dayIndex) => {
                            const cellData = row[dayIndex + 2];
                            if (cellData && cellData.trim() !== '') {
                                const match = cellData.trim().match(/(.+?) \((.+)\)$/); 
                                if (match) {
                                    const [_, mapelNama, guruNama] = match.map(s => s.trim());
                                    
                                    if (!tempSchedules[className][day]) tempSchedules[className][day] = {};
                                    
                                    tempGuruNames.add(guruNama);
                                    tempMapelNames.add(mapelNama);

                                    tempSchedules[className][day][sesi] = {
                                        nama: mapelNama,
                                        guru: guruNama
                                    };
                                }
                            }
                        });
                    }

                    if (tempClassNames.size === 0) {
                        throw new Error("Tidak ada data jadwal yang valid ditemukan di dalam file.");
                    }

                    kelas = Array.from(tempClassNames).map(nama => ({ id: `k-imp-${Date.now()}-${Math.random()}`, nama }));
                    guru = Array.from(tempGuruNames).map(nama => ({ id: `g-imp-${Date.now()}-${Math.random()}`, nama }));
                    mataPelajaran = Array.from(tempMapelNames).map(nama => ({ id: `m-imp-${Date.now()}-${Math.random()}`, nama }));
                    
                    const alokasiTracker = {};
                    Object.keys(tempSchedules).forEach(className => {
                        const classObj = kelas.find(k => k.nama === className);
                        if (!classObj) return;

                        Object.keys(tempSchedules[className]).forEach(day => {
                            Object.keys(tempSchedules[className][day]).forEach(sesi => {
                                const scheduleItem = tempSchedules[className][day][sesi];
                                const guruObj = guru.find(g => g.nama === scheduleItem.guru);
                                const mapelObj = mataPelajaran.find(m => m.nama === scheduleItem.nama);
                                
                                if (guruObj && mapelObj) {
                                    const key = `${classObj.id}-${guruObj.id}-${mapelObj.id}`;
                                    if(!alokasiTracker[key]) {
                                        alokasiTracker[key] = {
                                            id: `a-imp-${key}`,
                                            kelasId: classObj.id,
                                            guruId: guruObj.id,
                                            mapelId: mapelObj.id,
                                            sesi: 0
                                        };
                                    }
                                    alokasiTracker[key].sesi++;
                                    scheduleItem.id = alokasiTracker[key].id;
                                }
                            });
                        });
                    });

                    alokasiPelajaran = Object.values(alokasiTracker);
                    schedules = tempSchedules;

                    saveToLocalStorage();
                    renderAllLists();
                    renderAllSchedules();
                    updateButtonStates();
                    showToast('Jadwal berhasil diimpor!');
                } catch (error) {
                    showToast(`Gagal mengimpor: ${error.message}`, true);
                }
                event.target.value = '';
            }
        });
    });

    document.getElementById('export-all-csv-btn').addEventListener('click', () => {
        if (Object.keys(schedules).length === 0) {
            showToast('Belum ada jadwal untuk diexport!', true); return;
        }
        const data = [];
        const header = ['Kelas', 'Sesi', ...daysOrder];
        data.push(header);
        const uniqueSessions = Array.from({ length: 7 }, (_, i) => `Sesi ${i + 1}`);
        kelas.forEach(k => {
            const classSchedule = schedules[k.nama] || {};
            uniqueSessions.forEach(sesiKey => {
                const rowData = [k.nama, sesiKey];
                daysOrder.forEach(day => {
                    const mapelData = classSchedule[day]?.[sesiKey];
                    rowData.push(mapelData ? `${mapelData.nama} (${mapelData.guru})` : '');
                });
                data.push(rowData);
            });
        });
        const csv = Papa.unparse(data);
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = `jadwal_seluruh_kelas.csv`;
        link.click();
        URL.revokeObjectURL(link.href);
        showToast('Semua jadwal berhasil diexport!');
    });

    document.getElementById('delete-all-data-btn').addEventListener('click', () => {
        if(confirm('Apakah Anda yakin ingin menghapus semua data? Tindakan ini tidak dapat dibatalkan.')){
            kelas = []; guru = []; mataPelajaran = []; alokasiPelajaran = []; schedules = {};
            saveToLocalStorage();
            renderAllLists();
            renderAllSchedules();
            showToast('Semua data berhasil dihapus!', true);
        }
    });

    // --- CANVAS BACKGROUND LOGIC ---
    const canvas = document.getElementById('tech-background');
    const ctx = canvas.getContext('2d');
    let particlesArray;

    const setCanvasSize = () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    };

    class Particle {
        constructor(x, y, directionX, directionY, size, color) {
            this.x = x;
            this.y = y;
            this.directionX = directionX;
            this.directionY = directionY;
            this.size = size;
            this.color = color;
        }
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
            ctx.fillStyle = this.color;
            ctx.fill();
        }
        update() {
            if (this.x > canvas.width || this.x < 0) this.directionX = -this.directionX;
            if (this.y > canvas.height || this.y < 0) this.directionY = -this.directionY;
            this.x += this.directionX;
            this.y += this.directionY;
            this.draw();
        }
    }

    const init = () => {
        particlesArray = [];
        let numberOfParticles = (canvas.height * canvas.width) / 9000;
        for (let i = 0; i < numberOfParticles; i++) {
            let size = (Math.random() * 2) + 1;
            let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
            let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
            let directionX = (Math.random() * .4) - .2;
            let directionY = (Math.random() * .4) - .2;
            let color = 'rgba(207, 250, 254, 0.5)';
            particlesArray.push(new Particle(x, y, directionX, directionY, size, color));
        }
    };

    const connect = () => {
        let opacityValue = 1;
        for (let a = 0; a < particlesArray.length; a++) {
            for (let b = a; b < particlesArray.length; b++) {
                let distance = ((particlesArray[a].x - particlesArray[b].x) * (particlesArray[a].x - particlesArray[b].x)) +
                               ((particlesArray[a].y - particlesArray[b].y) * (particlesArray[a].y - particlesArray[b].y));
                if (distance < (canvas.width/7) * (canvas.height/7)) {
                    opacityValue = 1 - (distance/20000);
                    let color = 'rgba(207, 250, 254, ' + opacityValue + ')';
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(particlesArray[a].x, particlesArray[a].y);
                    ctx.lineTo(particlesArray[b].x, particlesArray[b].y);
                    ctx.stroke();
                }
            }
        }
    };

    const animate = () => {
        requestAnimationFrame(animate);
        ctx.clearRect(0, 0, innerWidth, innerHeight);
        for (let i = 0; i < particlesArray.length; i++) {
            particlesArray[i].update();
        }
        connect();
    };
    
    window.addEventListener('resize', () => {
        setCanvasSize();
        init();
    });

    // --- EVENT DELEGATION FOR CRUD ---
    document.getElementById('view-data').addEventListener('click', e => {
        const target = e.target.closest('button');
        if (!target) return;

        if (target.id && target.id.startsWith('add-')) {
            const type = target.id.replace('add-', '').replace('-btn', '');
            let modalId;
            if (type === 'matapelajaran') {
                modalId = 'matapelajaran-modal';
            } else {
                modalId = `${type}-modal`;
            }
            openModal(modalId);
        } else {
            const id = target.dataset.id;
            const type = target.dataset.type;
            if (!id || !type) return;

            if (target.classList.contains('edit-btn')) {
                if (type === 'kelas') openModal('kelas-modal', kelas.find(i => i.id === id));
                else if (type === 'guru') openModal('guru-modal', guru.find(i => i.id === id));
                else if (type === 'matapelajaran') openModal('matapelajaran-modal', mataPelajaran.find(i => i.id === id));
                else if (type === 'alokasi') openModal('alokasi-modal', alokasiPelajaran.find(i => i.id === id));
            } else if (target.classList.contains('delete-btn')) {
                if (type === 'kelas') handleDelete(id, kelas, renderKelasList, 'kelas');
                else if (type === 'guru') handleDelete(id, guru, renderGuruList, 'guru');
                else if (type === 'matapelajaran') handleDelete(id, mataPelajaran, renderMataPelajaranList, 'matapelajaran');
                else if (type === 'alokasi') handleDelete(id, alokasiPelajaran, renderAlokasiList, 'alokasi');
            }
        }
    });
    
    document.querySelectorAll('.close-modal-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.closest('.fixed');
            if (modal) {
                closeModal(modal.id);
            }
        });
    });

    const renderDashboardStatus = () => {
        const statusContainer = document.getElementById('dashboard-status');
        if (!statusContainer) return;

        if (kelas.length === 0) {
            statusContainer.innerHTML = `<p class="col-span-full text-center text-slate-400">Belum ada data kelas untuk ditampilkan.</p>`;
            return;
        }

        const totalSlots = daysOrder.length * 7; // 42
        statusContainer.innerHTML = kelas.map(k => {
            const classSchedule = schedules[k.nama] || {};
            let filledSlots = 0;
            Object.values(classSchedule).forEach(daySchedule => {
                filledSlots += Object.keys(daySchedule).length;
            });

            const percentage = totalSlots > 0 ? Math.round((filledSlots / totalSlots) * 100) : 0;
            const isComplete = percentage >= 100;

            return `
                <div class="glass-card p-4 rounded-lg flex flex-col gap-2 border-l-4 ${isComplete ? 'border-green-400' : 'border-cyan-400'}">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-lg">${k.nama}</span>
                        ${isComplete ? 
                            `<span class="flex items-center gap-1 text-sm text-green-400"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Lengkap</span>` :
                            `<span class="text-sm font-medium text-slate-300">${percentage}%</span>`
                        }
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-2.5">
                        <div class="h-2.5 rounded-full ${isComplete ? 'bg-green-500' : 'bg-cyan-500'}" style="width: ${percentage}%"></div>
                    </div>
                    <p class="text-xs text-slate-400">${filledSlots} dari ${totalSlots} sesi terisi.</p>
                </div>
            `;
        }).join('');
    };


    // --- INITIALIZATION ---
    switchView('#dashboard');
    renderAllLists();
    renderAllSchedules();
    setCanvasSize();
    init();
    animate();
    initializeClickToSwap();
});
</script>

</body>
</html>

